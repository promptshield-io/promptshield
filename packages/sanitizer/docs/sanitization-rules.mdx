---
title: Sanitization Rules
description: Understanding deterministic text sanitization.
---

# Sanitization Rules

Unlike the `@promptshield/core` engine, which is read-only and emits locations, `@promptshield/sanitizer` mutations text block formats deterministically. It is used to automatically rewrite bad prompts or fix security lints before committing code.

By default, the sanitizer performs "safe removals" and does **not** rely on the core detection engine. It is idempotent (running it 100 times yields the exact same string as running it once).

---

## The Default Pipeline (`sanitize`)

When using the `sanitize()` function (or running `promptshield sanitize`), the text goes through seven strict transformation steps in this exact order:

1. **Normalize line endings:** Converts any `\r\n` (CRLF) or `\r` (CR) endings to standard `\n` (LF) for cross-platform model consistency.
2. **Remove BOM:** Strips the Byte Order Mark (`\uFEFF`) which can confuse open-source tokenizers.
3. **Remove invisible characters:** Obliterates ZWSP, ZWNJ, ZWJ, Soft Hyphens, Word Joiners, Hangul Fillers, and Unicode Tag Characters.
4. **Remove variation selectors:** Strips Emoji/text presentation sequences (`\uFE00-\uFE0F`).
5. **Remove markdown comments:** Strips `<!-- ... -->` entirely to block payload smuggling in raw LLM inputs.
6. **Remove empty links:** Strips `[]()` sequences used for obfuscation.
7. **Normalize compatibility characters:** Selectively normalizes known "safe" compatibility characters (like No-Break Spaces or Ideographic Spaces) using `NFKC`.

*Note: The standard `sanitize` function does **not** run full-string NFKC normalization to preserve intentional typography or math symbols.*

---

## Strict Mode (`sanitizeStrict`)

If your system requires maximum hygiene and you do not care about preserving visual styling like script aliases or mathematical bolding, use `sanitizeStrict()`.

This mode runs the entire Default Pipeline, and then applies a full-document `NFKC` (Normalization Form Compatibility Composition) operation over the result.

```ts
import { sanitizeStrict } from "@promptshield/sanitizer";

// Normalizes â„Œello to Hello in addition to stripping invisibles.
const safeString = sanitizeStrict(inputString);
```

---

## Applying Explicit Fixes (`applyFixes`)

If you want to map `@promptshield/core` findings directly to resolutions without wholesale rewriting the document (which is what LSP "Quick Fixes" do), use the `applyFixes` API. 

This takes the `ThreatReport[]` output from the core scanner and surgically removes the exact indexed strings marked as malicious.

```ts
import { applyFixes } from "@promptshield/sanitizer";

const { text, fixed, skipped } = await applyFixes(originalContent, threats);

console.log(`Document cleaned. Removed ${fixed.length} threats.`);
```
